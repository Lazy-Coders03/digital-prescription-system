<!DOCTYPE html>
<html>
<head>
  <title>Pharmacy Verification</title>
</head>
<body>

<h2>Scan Prescription QR</h2>

<div id="reader" style="width:300px;"></div>

<div id="result" style="margin-top:20px;font-size:18px;"></div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  function onScanSuccess(decodedText) {
    console.log("QR Data:", decodedText);

    // STEP 1: Extract patient name
    const match = decodedText.match(/Patient:\s*(.+)/);

    if (!match) {
      document.getElementById("result").innerHTML =
        "❌ Invalid QR Code";
      return;
    }

    const patientName = match[1].trim();
    console.log("Patient:", patientName);

    // STEP 2: Call backend
    fetch(
      `https://digital-prescription-system.onrender.com/patient/${patientName}`
    )
      .then(res => res.json())
      .then(data => {
        if (data.length === 0) {
          document.getElementById("result").innerHTML =
            "❌ Fake or Expired Prescription";
        } else {
          const p = data[0];
          document.getElementById("result").innerHTML = `
            ✅ <b>Valid Prescription</b><br><br>
            Patient: ${p.patient}<br>
            Medicine: ${p.medicine}<br>
            Dose: ${p.dose}
          `;
        }
      })
      .catch(err => {
        console.error(err);
        document.getElementById("result").innerHTML =
          "❌ Verification failed";
      });
  }

  new Html5Qrcode("reader").start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
  );
</script>

</body>
</html>
